---
title: "Germany Retest"
format:
  html: 
    code-fold: true
---

Packages

```{r}
library(tidyverse)
library(glue)
library(here)
library(viridis)

# source(here("02_score_data","irt_helpers.R"))
# source(here("03_summaries", "plotting_helper.R"))
# source(here("03_explore_tasks/explore_helper.R"))
scores <- readRDS(here("02_scoring_outputs","scores","scores_combined.rds"))
```

Examine test/retest reliability in German data.

```{r}
# independent_thetas <- read_rds(here("02_scoring_outputs/scores/independent_scores.rds"))

de_retest_scores <- scores |> 
  filter(site == "pilot_leuphana_de", !(item_task %in% c("ha", "swr"))) |>
  group_by(user_id, item_task) |>
  arrange(user_id ,item_task, age) |>
  filter(n() > 1) |>
  mutate(run_number = row_number(),
         age_gap = c(0, diff(age))) 

retest_wide <- de_retest_scores |>
  group_by(user_id, item_task) |>
  mutate(has_retest = any(age_gap > .05), 
         mean_age = mean(age), 
         age_gap = max(age_gap)) |>
  filter(has_retest) |>
  ungroup() |>  
  pivot_wider(
    id_cols = c(user_id, item_task, mean_age, age_gap),
    names_from = run_number,
    values_from = metric_value,
    names_prefix = "run_"
  ) |>
  select(user_id, item_task, age = mean_age, age_gap, run_1, run_2)

independent_trt <- retest_wide |>
  group_by(item_task) |>
  summarise(test_retest_r = cor(run_1, run_2, use = "complete.obs"), 
            n = n(), 
            age_gap = mean(age_gap)*12) |>
  mutate(model = "independent")

knitr::kable(independent_trt, digits = 2)
  
```

```{r}
ggplot(retest_wide, 
       aes(x = run_1, y = run_2, col = age)) +
  geom_point() + 
  geom_smooth(aes(group = 1), col = "blue", method = "lm") + 
  scale_color_viridis() + 
  facet_wrap(~item_task) +
  xlab("Score 1") + ylab("Score 2") + 
  ggtitle("Test-retest reliability (DE)")
```
# Further exploration

```{r}
retest_directions <- retest_wide_mg |>
  mutate(direction = if_else(run_2 - run_1 > 0, "increase", "descrease")) |>
  select(user_id, item_task, direction)
retest_scores <- de_retest_scores_mg |>
  inner_join(retest_directions)
  # filter(run_number < 3)

# de_retest_scores |> semi_join(retest_wide |> select(user_id, item_task)) |>
# de_retest_scores_mg |> semi_join(retest_wide_mg |> select(user_id, item_task)) |>
ggplot(retest_scores, aes(x = age, y = metric_value)) +
  facet_wrap(vars(item_task), scales = "free", nrow = 2) +
  geom_line(aes(group = user_id, alpha = direction), size = .2) +
  geom_point(aes(color = factor(run_number)), size = .5) +
  .scale_color_default() +
  scale_alpha_manual(values = c(0.3, 1)) +
  labs(x = "Age", y = "Score", color = "Run") +
  theme(legend.position = "bottom")
ggsave(here("03_explore_tasks/plots/retest_age.png"), width = 8, height = 5)

ggplot(retest_scores |> filter(run_number <= 2),
       aes(x = factor(run_number), y = metric_value)) +
  facet_wrap(vars(item_task), scales = "free", nrow = 2) +
  geom_line(aes(group = user_id, alpha = direction), size = .2) +
  geom_point(aes(color = factor(run_number)), size = .5) +
  .scale_color_default() +
  scale_alpha_manual(values = c(0.3, 1)) +
  scale_x_discrete(expand = expansion(0.1)) +
  labs(x = "Run", y = "Score", color = "Run") +
  theme(legend.position = "bottom")
ggsave(here("03_explore_tasks/plots/retest_run.png"), width = 8, height = 5)
```
