---
title: "LEVANTE Thory of Mind task"
author: "Fionnuala O'Reilly"
toc: true
number-sections: true
highlight-style: pygments
format:
  html: 
    code-fold: true
---

Required packages

```{r}

#| echo: false

library("tidyverse")
library("glue")
library("here")
library("viridis")
library("quarto")

```

Helper functions

```{r}
#| echo: false

source(here::here("plot_settings.R"))
source(here("03_explore_tasks/explore_helper.R"))

```

Get tom data

```{r}
tom <- load_task_data("tom")
tom

```

Exploring item group

```{r}
base::table(tom$item_group)
sort(unique(tom$item_group))

```

Sum scores

```{r}

# 94 items

colnames(tom)

tom_runs <- tom |>
  filter(site != "us_pilot") |>
  group_by(site, user_id, run_id) |>
  summarise(
    correct = mean(correct, na.rm = TRUE),  
    age = mean(age, na.rm = TRUE),          
    n_items = n_distinct(item_uid) 
  )

tom_sum_scores <- ggplot(tom_runs, aes(x = age, y = correct)) +
  geom_point(alpha = 0.5) +
  geom_smooth(method = "gam", formula = y ~ s(x, bs = "re")) +
  ylim(0, 1) +
  facet_wrap(~site) +
  labs(
    title = "Age-related accuracy, smoothed trends by site",
    x = "Age (years)",
    y = "Proportion correct",
    caption = "Note: Each point represents a participant run; smoothed trend by site"
  )

print(tom_sum_scores)

ggsave(
  filename = here::here("03_explore_tasks", "Graphs", "tom_sum_scores.png"),
  plot = tom_sum_scores,
  width = 6,
  height = 4,
  dpi = 300
)

```

Item group

```{r}
tom_group_scores <- tom |>
  filter(site != "us_pilot") |>
  group_by(site, user_id, run_id, item_group) |>
  summarise(prop_correct = mean(correct, na.rm = TRUE), age = mean(age, na.rm = TRUE), .groups = "drop")

ggplot(tom_group_scores, aes(x = age, y = prop_correct, colour = item_group)) +
  geom_point(alpha = 0.4) +
  geom_smooth(method = "gam", formula = y ~ s(x, bs = "tp")) +
  facet_wrap(~site) +
  labs(x = "Age (years)", y = "Proportion correct", colour = "Item Group")
# bit messy.

# facet by group instead of country
tom_groups <- ggplot(tom_group_scores, aes(x = age, y = prop_correct, colour = site)) +
  geom_point(alpha = 0.2) +
  geom_smooth(method = "gam", formula = y ~ s(x, bs = "tp")) +
  facet_wrap(~item_group) +
  ylim(0, 1) +
  labs(
    title = "Raw accuracy by age across Theory of Mind sub-skills",
    x = "Age (years)",
    y = "Proportion correct",
    colour = "Site"
  )

print(tom_groups)

ggsave(
  filename = here::here("03_explore_tasks", "Graphs", "tom_groups.png"),
  plot = tom_groups,
  width = 6,
  height = 4,
  dpi = 300
)

```

Load IRT results

```{r}
scores <- read_rds(here("02_scoring_outputs","scores",
                             "scores_combined.rds"))
colnames(scores)
glimpse(scores)
unique(scores$item_task)

tom_irt_scores <- scores |>
  filter(item_task == "tom")

unique(tom_irt_scores$task_category)


```

Age-related trends in ToM ability estimates by site

```{r}

tom_irt <- scores %>%
  filter(item_task == "tom") %>% 
  select(site, item_task, user_id, run_id, metric_type, metric_value, age)

glimpse(tom_irt)

tom_irt_plot <- ggplot(tom_irt, aes(x = age, y = metric_value, col = site)) + 
  geom_point() + 
  geom_smooth() +
  labs(
    title = "Developmental trends in Theory of Mind ability by site",
    subtitle = "IRT-based theta estimates smoothed with GAM",
    x = "Age (years)",
    y = "Ability (IRT Theta Score)",
    colour = "Site"
  )
print(tom_irt_plot)

ggsave(
  filename = here::here("03_explore_tasks", "Graphs", "tom_irt.png"),
  plot = tom_irt,
  width = 6,
  height = 4,
  dpi = 300
)

```
Not working - item_group no longer in 'scores_combined' - check with Mika.
```{r}

# old
tom_coefs <- scores |>
  filter(item_task == "tom") |>
  mutate(item = str_replace(item, "_[12]","")) |>
  left_join(select(tom, item = task_id, item_group) |> distinct()) 

ggplot(tom_coefs, aes(x = item_group, y = -d, col = item_group)) +
  geom_point() +
  facet_wrap(~site) +
  labs(
    title = "IRT item difficulty estimates by site",
    x = "Item group",
    y = "Difficulty (IRT d)",
    colour = "Item group"
  ) +
  coord_flip()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

Find out which items are the bad ones.

```{r fig.width = 8, fig.height = 3}
item_raw_avgs <- tom |>
  filter(site != "us_pilot") |>
  group_by(item_uid, item_group, site) |>
  summarise(
    avg_correct = mean(correct, na.rm = TRUE),
    n_runs = n_distinct(run_id),
    chance = chance[1]
  ) |>
  arrange(avg_correct)

tom_items <- left_join(tom_coefs, item_raw_avgs, by = c("item" = "item_uid", "site", "item_group"))

tom_items |>
  filter(d < 10) |>
  arrange(d) |>
  select(item, item_group, site, d, avg_correct, n_runs) 

tom_items |>
  filter(avg_correct < .5) |>
  arrange(avg_correct) |>
  select(item, item_group, site, d, avg_correct, n_runs, chance) |>
  knitr::kable(digits = 2)


ggplot(tom_items, aes(x = d, y = avg_correct)) +
  geom_point(aes( col = item_group)) +
  geom_smooth(method = "lm", aes(group = 1)) + 
  facet_wrap(~site) +
  labs(
    title = "IRT item difficulty estimates vs. raw accuracy",
    x = "Difficulty (IRT d)",
    y = "Average correct",
    colour = "Item group"
  ) 
```

# Hostile Attribution

```{r}
ha <- load_task_data("ha")

ha_runs <- ha |>
  filter(site != "us_pilot") |>
  group_by(site, user_id, run_id, item) |>
  summarise(
    correct = mean(correct, na.rm = TRUE),  
    age = mean(age, na.rm = TRUE),          
    n_items = n_distinct(item_uid) 
  )

ha_sum_scores <- ggplot(ha_runs, aes(x = age, y = correct)) +
  geom_point(alpha = 0.5) +
  geom_smooth(method = "gam", formula = y ~ s(x, bs = "re")) +
  ylim(0, 1) +
  facet_grid(item~site) +
  labs(
    x = "Age (years)",
    y = "Proportion Correct"
  )

print(ha_sum_scores)

ggsave(
  filename = here::here("03_explore_tasks", "Graphs", "ha_sum_scores.png"),
  plot = ha_sum_scores,
  width = 6,
  height = 4,
  dpi = 300
)
```

```{r}


ha_irt_scores <- scores |>
  filter(item_task == "ha")


ha_irt <- ggplot(ha_irt_scores, aes(x = age, y = metric_value, col = site)) + 
  geom_point() + 
  geom_smooth() +
  labs(
    title = "Developmental trends in Hostile Attribution by site",
    subtitle = "IRT-based theta estimates smoothed with GAM",
    x = "Age (years)",
    y = "Ability (IRT Theta Score)",
    colour = "Site"
  )
print(ha_irt)

ggsave(
  filename = here::here("03_explore_tasks", "Graphs", "ha_irt.png"),
  plot = ha_irt,
  width = 6,
  height = 4,
  dpi = 300
)
```



```{r}
survey_scores <- readRDS(here("03_summaries","efa","caregiver_fscore_all.rds"))

colnames(survey_scores)
unique(survey_scores$site)

survey_scores_filtered <- survey_scores |>
  filter(site == "de_leipzig") |>
  select(user_id = child_id, form_construct, form_subconstruct, value) 

# how many unique participants
survey_scores_filtered %>%
  summarise(n_participants = n_distinct(user_id))


ha_wide <- ha_runs |>
  ungroup() |>
  filter(site == "pilot_leuphana_de") |>
  select(-run_id, -n_items) |>
  pivot_wider(names_from = "item", values_from = "correct")
  
ha_surveys <- inner_join(survey_scores_filtered, ha_wide, by = "user_id")

# debug
colnames(ha_runs)
unique(ha_runs$site)
```

Action

```{r}
ha_surveys$ha_composite <- (ha_surveys$action + ha_surveys$attribution)/2

ha_action <- ggplot(ha_surveys, aes(x = value, y = action, col = age)) + 
  geom_jitter(alpha = .5, height = .05, width = 0) +
  geom_smooth(method = "lm", aes(group = 1), col = "blue") + 
  facet_wrap(~form_subconstruct) +
  labs(
    title = "Survey scores vs. Hostile Attribution (action), by subconstruct & age",
    x = "Survey score",
    y = "Hostile attribution (action)"
  ) +
  theme(
    plot.title = element_text(size = 13),   # smaller title
    strip.text = element_text(size = 8),
    strip.text.x = element_text(angle = 0),
    strip.placement = "outside"
  )

print(ha_action)

ggsave(
  filename = here::here("03_explore_tasks", "Graphs", "ha_action.png"),
  plot = ha_action,
  width = 6,
  height = 4,
  dpi = 300
)

```

Attribution

```{r}

ha_attribution <- ggplot(ha_surveys, aes(x = value, y = attribution, col = age)) + 
  geom_jitter(alpha = .5, height = .05, width = 0) +
  geom_smooth(method = "lm", aes(group = 1), col = "blue") + 
  facet_wrap(~form_subconstruct) +
  labs(
    title = "Survey scores vs. Hostile Attribution (attribution), by subconstruct & age",
    x = "Survey score",
    y = "Hostile attribution (attribution)"
  ) +
  theme(
    plot.title = element_text(size = 11),
    strip.text = element_text(size = 8),
    strip.text.x = element_text(angle = 0),
    strip.placement = "outside"
  )

print(ha_attribution)

ggsave(
  filename = here::here("03_explore_tasks", "Graphs", "ha_attribution.png"),
  plot = ha_attribution,
  width = 6,
  height = 4,
  dpi = 300
)

```

Composite

```{r}
ha_composite_graph <- ggplot(ha_surveys, aes(x = value, y = ha_composite, col = age)) + 
  geom_jitter(alpha = .5, height = .05, width = 0) +
  geom_smooth(method = "lm", aes(group = 1), col = "blue") + 
  facet_wrap(~form_subconstruct) +
  labs(
    title = "Survey scores vs. Hostile Attribution (composite), by subconstruct & age",
    x = "Survey score",
    y = "Hostile attribution (composite)"
  ) +
  theme(
    plot.title = element_text(size = 11),
    strip.text = element_text(size = 8),
    strip.text.x = element_text(angle = 0),
    strip.placement = "outside"
  )
print(ha_composite_graph)

ggsave(
  filename = here::here("03_explore_tasks", "Graphs", "ha_composite.png"),
  plot = ha_composite_graph,
  width = 6,
  height = 4,
  dpi = 300
)
```

Correlation table

```{r}
ha_surveys |>
  group_by(form_subconstruct) |>
  summarise(attribution_corr = cor(value, attribution), 
            action_corr = cor(value, action), 
            ha_composite_corr = cor(value, ha_composite)) |>
  knitr::kable(digits = 2)


#export
ha_table <- ha_surveys |>
  group_by(form_subconstruct) |>
  summarise(
    Attribution_r = round(cor(value, attribution, use = "pairwise.complete.obs"), 2),
    Action_r      = round(cor(value, action,      use = "pairwise.complete.obs"), 2),
    Composite_r   = round(cor(value, ha_composite,use = "pairwise.complete.obs"), 2)
  )

write_csv(ha_table, "ha_correlations.csv")
getwd()


```

trimming out extreme low survey scores

```{r}
ha_surveys |>
  filter(value > -5) |>
  group_by(form_subconstruct) |>
  summarise(attribution_corr = cor(value, attribution), 
            action_corr = cor(value, action), 
            ha_composite_corr = cor(value, ha_composite)) |>
  knitr::kable(digits = 2)

# export
ha_trimmed <- ha_surveys |>
  group_by(form_subconstruct) |>
  summarise(
    Attribution_r = round(cor(value, attribution, use = "pairwise.complete.obs"), 2),
    Action_r      = round(cor(value, action,      use = "pairwise.complete.obs"), 2),
    Composite_r   = round(cor(value, ha_composite,use = "pairwise.complete.obs"), 2)
  )

write_csv(ha_table, "ha_correlations_trimmed.csv")
getwd()
```
