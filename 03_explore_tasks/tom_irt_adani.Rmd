---
title: "TOM IRT Models"
author: "Adani Abutto"
date: "`r Sys.Date()`"
output:
  bookdown::html_document2:
    toc: true
    toc_depth: 3
    toc_float: true
    theme: cosmo
    highlight: tango

header-includes:
    - \usepackage{setspace}\doublespacing
---

# Background Info

Info on data structure:
<https://docs.google.com/document/d/1v-nqBxk3R9cSbvJshaBsWQp7KUtBjQSdMNXHw9NDfKg/edit?tab=t.0#heading=h.c60fcjq089m>

Item descriptions:
<https://docs.google.com/document/d/1JKKrdS3_JjbLTuF682KqIoDpWIeeMhrOdfQn0Lt1Dv0/edit?tab=t.0>

------------------------------------------------------------------------------------------

# Setup

```{r setup, include = F, message = F, warning = F}

# load relevant libraries and functions
library(here)
library(glue)
library(png)           # for working with images
library(grid)
library(mirt)          # for IRT models
library(patchwork)     # for multiple plots
library(tidyverse)     # for everything else
library(dplyr)

# set default code chunk options
knitr::opts_chunk$set(echo = T, warning = F, message = F)

# set default plot theme 
theme_set(theme_classic() + 
            theme(text = element_text(size = 18))) 

# fix print width for knitted doc
options(width = 70)

# set random seed
set.seed(1)

```

```{r}

# read in the data
tom_data_long =
  read_rds(here("01_fetched_data/task_data_nested.rds")) %>%
  # keep only tom tasks
  filter(item_task == "tom",
         # keep only Canada, Colombia, Germany
         site %in% c("ca_pilot", "co_pilot", "de_pilot")) %>%
  # unnest
  unnest(data) %>%
  # rename group to site
  rename(group = site) %>%
  # filter out missing item uids
  filter(!is.na(item_uid)) %>%
  # convert booleans to numeric
  mutate(correct = unlist(correct)) %>%
  mutate(correct = case_when(correct == T ~ 1,
                             correct == F ~ 0,
                             TRUE ~ NA_real_))

```

```{r}

# number of items
Hmisc::describe(tom_data_long$item)

# number of item groups
Hmisc::describe(tom_data_long$item_group)

# test sites
Hmisc::describe(tom_data_long$dataset)

```

There are **38 items** total, clustered into 6 **item groups** (deception, interpretation,
moral reasoning, reality/false belief, reference, and second order).

There are also **three test sites**: CA, CO, and DE

For each, we have **four different IRT models** we want to run:

1.  1PL/Rasch model
2.  1PL/Rasch model but with configural scoring
3.  2PL model
4.  2PL model but with configural scoring

------------------------------------------------------------------------------------------

# IRT Models

Now we want to compute **item difficulties and item discrimination at the item level**. We
have 38 items, all of which were administered at each of the 3 sites, so we should end up
with **116 entries**.

```{r}

# create wide df
tom_irt_data =
  tom_data_long %>%
  select(user_id, group, run_id, group, item, item_uid,
         item_group, timestamp, trial_id, response, answer, correct) %>%
  # if there are multiple responses for the same item, keep only the *last* response for each child
  arrange(user_id, item_uid) %>%
  group_by(user_id, item_uid) %>%
  slice_tail(n = 1) %>%
  ungroup() %>%
  # pivot to wide format
  pivot_wider(id_cols = user_id,
              names_from = item_uid,
              values_from = correct)

# create response matrix for IRT models
# keep only "correct" col
response_matrix =
  tom_irt_data %>%
  select(where(is.numeric)) %>%
  as.data.frame()

# create group vector for multigroup model
group_vec =
  tom_data_long %>%
  select(user_id, group) %>%
  distinct(user_id, group) %>%
  filter(user_id %in% tom_data_long$user_id) %>%
  arrange(match(user_id, tom_data_long$user_id)) %>%
  pull(group)

```

```{r}

# create function to fit models
fit_irt_model =
  function(tom_irt_data, model_type = "Rasch", group_vec = NULL) {
    # fit model
    if (!is.null(group_vec)) {
      model =
        # configural model
        multipleGroup(data = response_matrix,
                      # unidimensional
                      model = 1,
                      group = group_vec,
                      itemtype = model_type,
                      # no invariance
                      invariance = "",
                      verbose = T,
                      technical = list(NCYCLES = 5000))
      
      } else
        {
          model =
            # nonconfigural model
            mirt(data = response_matrix,
                 # unidimensional
                 model = 1,
                 itemtype = model_type,
                 technical = list(NCYCLES = 5000),
                 verbose = T)
          }
    return(model)
    }

```

```{r}

# fit 1PL Rasch model, nonconfigural
mod_rasch =
  fit_irt_model(tom_irt_data,
                model_type = "Rasch")

```

```{r}

# fit 2PL model, nonconfigural
mod_2pl =
  fit_irt_model(tom_irt_data,
                model_type = "2PL")

```

```{r}

# fit 1 PL Rasch model, *configural*
mod_rasch_configural =
  fit_irt_model(tom_irt_data,
                model_type = "Rasch",
                group_vec = group_vec)

```

```{r}

# fit 2 PL Rasch model, *configural*
mod_2pl_configural =
  fit_irt_model(tom_irt_data,
                model_type = "2PL",
                group_vec = group_vec)

```
