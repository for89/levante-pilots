```{r setup}
library(tidyverse)
library(here)
library(glue)
library(ggforce)
library(ggthemes)

source(here("03_summaries/plotting_helper.R"))
source(here("03_summaries/scores_helper.R"))
```

```{r}
# sites <- c("ca_pilot", "co_pilot", "de_pilot", "us_pilot")
# 
# participants <- sites |>
#   set_names() |>
#   map(\(s) read_rds(here(glue("00_prepped_data/{s}/participants.rds")))) |>
#   list_rbind(names_to = "site")
run_ages <- read_rds(here(glue("01_fetched_data/run_data.rds"))) |>
  select(site, task_id, user_id, run_id, age)
```

Combine all task scores into one plot!

```{r}
scores <- combine_scores()

task_categories_vec <- levels(scores$task_category)
task_pal <- ptol_pal()(length(task_categories_vec)) |> set_names(task_categories_vec)
```


```{r}
# threshold_n <- 10
threshold_n <- 10
threshold_scores <- scores |> filter(site_task_n >= threshold_n)

sumscores <- threshold_scores |> filter(metric_type == "prop_correct")

irt_scores <- threshold_scores |>
  filter(str_detect(metric_type, "ability"))

task_scores <- threshold_scores |>
  mutate(metric_type = if_else(str_detect(metric_type, "ability"), "ability", metric_type)) |>
  filter(!is.na(metric_value)) |>
  inner_join(task_metrics) 
```


With just the LEVANTE original tasks. 

```{r}
task_plot_comparative(filter(task_scores, 
                             model == "full pooling IRT",
                             # site != "us_pilot", 
                             task %in% 
                               c("hearts-and-flowers","memory-game","same-different-selection", 
                                 "egma-math", "mental-rotation", "trog","vocab","theory-of-mind"))
                               , ylab = "Score", nr = 2)
ggsave(here("03_summaries/plots/levante_tasks_full_pooling.png"), width = 10, height = 6)
```

```{r}
task_plot_comparative(filter(task_scores, 
                             model == "no pooling IRT",
                             site != "us_pilot",
                             task %in% 
                               c("hearts-and-flowers","memory-game","same-different-selection", 
                                 "egma-math", "mental-rotation", "trog","vocab","theory-of-mind"))
                               , ylab = "Score", nr = 2)
ggsave(here("03_summaries/plots/levante_tasks_no_pooling.png"), width = 10, height = 6)
```

Ages. 

```{r}
ages <- task_scores |>
  group_by(user_id, site) |>
  summarise(age = mean(age))

ns <- ages |>
  group_by(site) |>
  count()

ggplot(ages, aes(x = age, fill = site)) + 
  geom_histogram(binwidth = 1)  + 
  guides(fill= "none") + 
  facet_wrap(~site)

ggsave(here("03_summaries/plots/ages.png"), 
       width = 8, height = 3, create.dir = TRUE)
```

