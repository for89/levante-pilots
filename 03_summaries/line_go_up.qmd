```{r setup}
library(tidyverse)
library(here)
library(glue)
library(ggforce)
library(ggthemes)
library(ggh4x)

source(here("plot_settings.R"))
source(here("03_summaries/plotting_helper.R"))
source(here("03_summaries/scores_helper.R"))
```

Combine all task scores into one plot!

```{r}
task_scores <- read_rds(here("02_scoring_outputs/scores/scores_combined.rds"))
site_labels <- c("uniandes-co" = "pilot_uniandes_co",
                 "mpieva-de" = "pilot_mpieva_de",
                 "western-ca" = "pilot_western_ca")

task_scores_labeled <- task_scores |>
  mutate(task = task |> str_to_title() |> fct_inorder(),
         task_category = task_category |> str_to_title() |> fct_inorder()) |>
  group_by(site, task) |>
  mutate(site_task_label = glue("{task}\n(n = {n_distinct(run_id)})")) |>
  group_by(task) |>
  mutate(task_label = glue("{task}\n(n = {n_distinct(run_id)})")) |>
  ungroup() |>
  mutate(site = site |> fct_recode(!!!site_labels)) |>
  group_by(site) |>
  mutate(site_label = glue("{site} (n = {n_distinct(run_id)})")) |>
  ungroup()
```

With just the LEVANTE original tasks. 

```{r}
levante_tasks <- c("hearts-and-flowers", "memory-game", "same-different-selection", 
                   "egma-math", "mental-rotation", "matrix-reasoning", "trog", "vocab", "theory-of-mind")
 
site_labels <- task_scores_labeled |>
  distinct(site, site_label) |>
  deframe() |>
  as.character()
```

```{r}
task_scores_labeled |>
  filter(task_id %in% levante_tasks) |>
  task_plot_comparative(ylab = "Score", nr = 2)
ggsave(here("03_summaries/plots/levante_tasks.png"), width = 11, height = 6)
```

```{r}
# task_scores |>
#   filter(str_detect(model_class, "by_language"),
#          task_id %in% levante_tasks,
#          site %in% ref_sites) |>
#   task_plot_comparative(ylab = "Score", nr = 2)
# ggsave(here("03_summaries/plots/levante_tasks_bylanguage.png"), width = 11, height = 6)
```

```{r}
# task_scores |>
#   filter(str_detect(model_class, "multigroup"),
#          task_id %in% levante_tasks,
#          site %in% ref_sites) |>
#   task_plot_comparative(ylab = "Score", nr = 2)
# ggsave(here("03_summaries/plots/levante_tasks_multigroup.png"), width = 11, height = 6)
```

Everything on the plots.

```{r}
task_scores_labeled |>
  task_plot_comparative(ylab = "Score", nr = 3)
ggsave(here("03_summaries/plots/all_tasks.png"), width = 11, height = 8)
```

```{r}
# task_scores |>
#   filter(is.na(model) | str_detect(model_class, "by_language")) |>
#   task_plot_comparative(ylab = "Score", nr = 3)
# ggsave(here("03_summaries/plots/all_tasks_bylanguage.png"), width = 11, height = 8)
```

```{r}
# task_scores |>
#   filter(is.na(model) | str_detect(model_class, "multigroup")) |>
#   task_plot_comparative(ylab = "Score", nr = 3)
# ggsave(here("03_summaries/plots/all_tasks_multigroup.png"), width = 11, height = 8)
```

Ages. 

```{r}
ages <- task_scores |>
  group_by(user_id, site) |>
  summarise(age = mean(age))

ns <- ages |>
  group_by(site) |>
  count()

ggplot(ages, aes(x = age, fill = site)) + 
  geom_histogram(binwidth = 1)  + 
  guides(fill= "none") + 
  facet_wrap(~site)

ggsave(here("03_summaries/plots/ages.png"), 
       width = 8, height = 3, create.dir = TRUE)
```
