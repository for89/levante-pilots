```{r}
library(tidyverse)
library(glue)
library(here)

sites <- c("ca_pilot", "co_pilot", "de_pilot")

task_data_nested <- sites |>
  set_names() |>
  map(\(s) read_rds(here(glue("01_processed_data/{s}/task_data_nested.rds")))) |>
  list_rbind(names_to = "site")

task_data_combined <- task_data_nested |>
  select(-task_id) |>
  unnest(data)
```

Get trog data

```{r}

trog <- filter(task_data_combined, 
             task_id %in% c("trog"))

trog

```

Get ages

```{r}
participants <- sites |>
  set_names() |>
  map(\(s) read_rds(here(glue("00_prepped_data/{s}/participants.rds")))) |>
  list_rbind(names_to = "site")

run_ages <- participants |>
  select(user_id, ages) |>
  unnest(ages)

# this is useful below for various simplifications
ages <- run_ages |>
  group_by(user_id) |>
  summarise(age = mean(age))

trog <- left_join(trog, ages)

colnames(trog)
View (trog)

# ISSUE 1 : For one trog item, the question is written out e.g., the pencil is neither long nor red.

```

Linking trial-level data to item-level metadata

```{r}
id_map <- read_csv(here("02_score_data/item_metadata/pilot-item-ID mapping.csv"))

trial_id_map <- id_map |>
  mutate(trials = trials |> str_split(",")) |>
  unnest(trials) |>
  rename(trial_id = trials) |>
  mutate(trial_id = str_trim(trial_id))

# Join trial-level data to IRT item IDs

trog <- trog |>
  left_join(trial_id_map, by = "trial_id") |>
  filter(!is.na(item_uid))

trog

```

Exploring item types

```{r}

table(trog$corpus_trial_type)
sort(unique(trog$corpus_trial_type))

# Dupicate of 'post modified subject - update
trog <- trog |>
  mutate(corpus_trial_type = case_when(
    corpus_trial_type == "post modified subject" ~ "postmodified subject",
    TRUE ~ corpus_trial_type
  ))

sort(unique(trog$corpus_trial_type))
sort(unique(trog$item_id))
length(unique(trog$item_id)) # must be using Trog2 (2003 version) as Trog1 only has 80 items

```

Extract coefficeints from IRT model

```{r}

# Load multigroup IRT model outputs
best_multigroup <- readRDS(here("02_scored_data", "irt_outputs", "multigroup_best_outputs.rds"))
multigroup_scores <- readRDS(here("02_scored_data", "scores", "scores_multigroup.rds"))

View(best_multigroup)

trog_models <- best_multigroup$coefs[[which(best_multigroup$task_id == "trog")]]
length(trog_models)
str(trog_models)

# Assign site labels and flatten
trog_coefs <- trog_models |> 
  filter(str_detect(item, "^trog_"))  

# Calculate mean difficulty (d) per item across sites
trog_difficulty_overall <- trog_coefs |>
  group_by(item) |>
  summarise(mean_d = mean(d, na.rm = TRUE), .groups = "drop") |>
  arrange(mean_d)

# Assign block numbers (4 items per block, 25 blocks total)
trog_difficulty_blocks <- trog_difficulty_overall |>
  mutate(block = ceiling(row_number() / 4))

# Join block info back into full site-level IRT data
trog_difficulty <- trog_coefs |>
  left_join(trog_difficulty_blocks |> select(item, mean_d, block), by = "item")

# Check
trog_difficulty |> count(block)
View(trog_difficulty)


```

Plot item difficulty (mean across sites)

```{r}

ggplot(trog_difficulty_blocks, aes(x = reorder(item, mean_d), y = mean_d)) +
  geom_point() +
  coord_flip() +
  labs(
    x = "Item (ordered by mean difficulty)",
    y = "Mean Difficulty (d)",
    title = "TROG Item Difficulty (Mean Across Sites)"
  ) +
  theme_minimal() +
  theme(axis.text.y = element_text(size = 6))


```
# Germany only
```{r}

trog_de <- trog_coefs |> 
  filter(site == "de_pilot")


ggplot(trog_de, aes(x = d)) +
  geom_density(fill = "#56B4E9", alpha = 0.6) +
  labs(
    title = "Density of Item Difficulty (Germany)",
    x = "Difficulty (d)",
    y = "Density"
  ) +
  theme_minimal()



```
# Columbia only
```{r}
trog_co <- trog_coefs |> 
  filter(site == "co_pilot")


ggplot(trog_co, aes(x = d)) +
  geom_density(fill = "#56B4E9", alpha = 0.6) +
  labs(
    title = "Density of Item Difficulty (Columbia)",
    x = "Difficulty (d)",
    y = "Density"
  ) +
  theme_minimal()


```
# Canada only
```{r}

trog_ca <- trog_coefs |> 
  filter(site == "ca_pilot")


ggplot(trog_ca, aes(x = d)) +
  geom_density(fill = "#56B4E9", alpha = 0.6) +
  labs(
    title = "Density of Item Difficulty (Canada)",
    x = "Difficulty (d)",
    y = "Density"
  ) +
  theme_minimal()

```

```{r}

```